#!/bin/bash

# Параметры подключения
DB_PATH="/tmp/user_survey_Mustafin.fdb"
USER="sysdba"
PASSWORD="masterkey"

# Удаляем старую базу данных, если она существует
if [ -f "$DB_PATH" ]; then
    echo "Удаление старой базы данных..."
    rm "$DB_PATH"
fi

# Создаём новую базу данных
echo "Создание новой базы данных..."
isql -user $USER -password $PASSWORD « EOF
CREATE DATABASE '$DB_PATH' USER '$USER' PASSWORD '$PASSWORD';
EOF

# Создаём таблицы
echo "Создание таблиц..."

isql -user $USER -password $PASSWORD $DB_PATH « EOF
CREATE TABLE USERS (
    ID_USERS INTEGER GENERATED BY DEFAULT AS IDENTITY (START WITH 1),
    USERNAME VARCHAR(50),
    EMAIL VARCHAR(90),
    PASSWORD VARCHAR(255),
    CONSTRAINT PK_USERS PRIMARY KEY (ID_USERS)
);

CREATE TABLE SURVEYS (
    ID_SURVEY INTEGER GENERATED BY DEFAULT AS IDENTITY (START WITH 1),
    TITLE VARCHAR(90),
    DESCRIPTION VARCHAR(255),
    CONSTRAINT PK_SURVEYS PRIMARY KEY (ID_SURVEY)
);

CREATE TABLE QUESTION (
    ID_QUESTION INTEGER GENERATED BY DEFAULT AS IDENTITY (START WITH 1),
    ID_SURVEY INTEGER NOT NULL,
    TEXT VARCHAR(255) NOT NULL,
    QUESTION_TYPE VARCHAR(30),
    CONSTRAINT INTEG_1 PRIMARY KEY (ID_QUESTION) USING ASCENDING INDEX RDB$PRIMARY1,
    CONSTRAINT INTEG_4 CHECK (QUESTION_TYPE IN ('OPEN_ENDED', 'CLOSED', 'PARTIALLY_OPEN')),
    CONSTRAINT INTEG_5 FOREIGN KEY (ID_SURVEY) REFERENCES SURVEYS (ID_SURVEY) USING ASCENDING INDEX RDB$FOREIGN2
);

CREATE TABLE ANSWERS (
    ID_ANSWERS INTEGER GENERATED BY DEFAULT AS IDENTITY (START WITH 1),
    ID_QUESTION INTEGER NOT NULL,
    ID_USERS INTEGER NOT NULL,
    ANSWER_TEXT VARCHAR(1024) NOT NULL,
    CONSTRAINT INTEG_12 PRIMARY KEY (ID_ANSWERS) USING ASCENDING INDEX RDB$PRIMARY5,
    CONSTRAINT INTEG_16 FOREIGN KEY (ID_QUESTION) REFERENCES QUESTION (ID_QUESTION) USING ASCENDING INDEX RDB$FOREIGN6,
    CONSTRAINT INTEG_17 FOREIGN KEY (ID_USERS) REFERENCES USERS (ID_USERS) USING ASCENDING INDEX RDB$FOREIGN7
);
EOF

echo "База данных и таблицы успешно созданы!"
